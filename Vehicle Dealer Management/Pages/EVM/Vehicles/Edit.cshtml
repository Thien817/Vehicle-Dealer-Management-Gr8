@page "/EVM/Vehicles/Edit"
@model Vehicle_Dealer_Management.Pages.EVM.Vehicles.EditModel
@{
    ViewData["Title"] = "Chỉnh sửa xe";
    ViewData["UserRole"] = "EVM_STAFF";
    ViewData["UserName"] = HttpContext.Session.GetString("UserName") ?? "EVM Staff";
}

<div class="content-header">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="content-title">Chỉnh sửa xe</h1>
            <p class="content-subtitle">Cập nhật thông tin mẫu xe điện</p>
        </div>
        <a href="/EVM/Vehicles/Index" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Quay lại
        </a>
    </div>
</div>

@if (TempData["Error"] != null)
{
    <div class="alert alert-error" style="margin-bottom: 1.5rem; padding: 1rem; background: var(--error-bg); border: 1px solid var(--error); border-radius: var(--radius-sm); color: var(--error);">
        <i class="bi bi-exclamation-triangle"></i> @TempData["Error"]
    </div>
}

@if (Model.ErrorMessage != null)
{
    <div class="alert alert-error" style="margin-bottom: 1.5rem; padding: 1rem; background: var(--error-bg); border: 1px solid var(--error); border-radius: var(--radius-sm); color: var(--error);">
        <i class="bi bi-exclamation-triangle"></i> @Model.ErrorMessage
    </div>
}

@if (Model.Vehicle != null)
{
    <form method="post">
        <input type="hidden" name="vehicleId" value="@Model.Vehicle.Id" />
        <div class="grid grid-cols-3 gap-3">
            <!-- Left Column: Vehicle Info -->
            <div style="grid-column: span 2;">
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title mb-0">Thông tin cơ bản</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-cols-2 gap-2">
                            <div class="form-group">
                                <label class="form-label">Tên mẫu xe <span style="color: var(--error);">*</span></label>
                                <input type="text" class="form-control" name="modelName" value="@Model.Vehicle.ModelName" placeholder="Ví dụ: Model 3" required />
                                <small class="form-text">Tên chính của dòng xe</small>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Phiên bản <span style="color: var(--error);">*</span></label>
                                <input type="text" class="form-control" name="variantName" value="@Model.Vehicle.VariantName" placeholder="Ví dụ: Standard" required />
                                <small class="form-text">Phiên bản: Standard, Premium, Performance...</small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">URL hình ảnh <span style="color: var(--error);">*</span></label>
                            <input type="url" class="form-control" name="imageUrl" value="@Model.Vehicle.ImageUrl" placeholder="https://example.com/image.jpg" required />
                            <small class="form-text">Link ảnh xe (có thể dùng Unsplash, Imgur...)</small>
                        </div>

                        <div class="form-group mb-0">
                            <label class="form-label">Trạng thái</label>
                            <select class="form-control" name="status">
                                @if (Model.Vehicle.Status == "AVAILABLE")
                                {
                                    <option value="AVAILABLE" selected>Có sẵn (AVAILABLE)</option>
                                }
                                else
                                {
                                    <option value="AVAILABLE">Có sẵn (AVAILABLE)</option>
                                }
                                @if (Model.Vehicle.Status == "COMING_SOON")
                                {
                                    <option value="COMING_SOON" selected>Sắp ra mắt (COMING_SOON)</option>
                                }
                                else
                                {
                                    <option value="COMING_SOON">Sắp ra mắt (COMING_SOON)</option>
                                }
                                @if (Model.Vehicle.Status == "DISCONTINUED")
                                {
                                    <option value="DISCONTINUED" selected>Ngừng sản xuất (DISCONTINUED)</option>
                                }
                                else
                                {
                                    <option value="DISCONTINUED">Ngừng sản xuất (DISCONTINUED)</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Pricing -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title mb-0">Giá bán</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">% Giảm giá (tùy chọn)</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="number" class="form-control" id="vehicleDiscountPercent" name="discountPercent" min="0" max="100" step="0.1" placeholder="0" onchange="calculateVehiclePrice()" style="flex: 1;" />
                                <span style="color: var(--text-muted);">%</span>
                            </div>
                            <small class="form-text">Nhập % giảm giá để tự động tính giá cuối cùng. Hệ thống sẽ tự động tạo chính sách giá mới với giảm giá này.</small>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="form-group">
                                <label class="form-label">Giá MSRP (VND) <span style="color: var(--text-muted);">(giá gốc)</span></label>
                                <input type="number" class="form-control" id="vehicleMsrp" name="msrp" value="@Model.Vehicle.Msrp.ToString("0")" placeholder="2500000000" step="1000000" onchange="calculateVehiclePrice()" />
                                <small class="form-text">Giá niêm yết (Manufacturer's Suggested Retail Price)</small>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Giá buôn (VND) <span style="color: var(--text-muted);">(giá gốc)</span></label>
                                <input type="number" class="form-control" id="vehicleWholesalePrice" name="wholesalePrice" value="@Model.Vehicle.WholesalePrice.ToString("0")" placeholder="2300000000" step="1000000" onchange="calculateVehiclePrice()" />
                                <small class="form-text">Giá bán buôn cho đại lý</small>
                            </div>
                        </div>
                        <div class="alert alert-info" id="vehiclePricePreview" style="display: none; margin-top: 1rem; padding: 0.75rem; background: var(--info-bg, rgba(59, 130, 246, 0.1)); border: 1px solid var(--info, #3b82f6); border-radius: var(--radius-sm); color: var(--info, #3b82f6); font-size: 0.875rem;">
                            <strong>Giá sau giảm:</strong><br>
                            <span id="vehicleDiscountedMsrp"></span><br>
                            <span id="vehicleDiscountedWholesale"></span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ghi chú về giá (tùy chọn)</label>
                            <textarea class="form-control" name="priceNote" id="vehiclePriceNote" rows="3" placeholder="Ví dụ: Giá đã bao gồm khuyến mãi 20%. Giá có thể thay đổi tùy theo đại lý..."></textarea>
                            <small class="form-text">Ghi chú này sẽ hiển thị trên trang chi tiết xe để khách hàng xem</small>
                        </div>
                        <div class="alert alert-info" style="margin-top: 1rem; padding: 0.75rem; background: var(--info-bg, rgba(59, 130, 246, 0.1)); border: 1px solid var(--info, #3b82f6); border-radius: var(--radius-sm); color: var(--info, #3b82f6); font-size: 0.875rem;">
                            <i class="bi bi-info-circle"></i> <strong>Lưu ý:</strong> Nếu để trống, giá hiện tại sẽ được giữ nguyên. Nếu nhập % giảm giá, hệ thống sẽ tạo chính sách giá mới với giá đã giảm và thông báo cho customers.
                        </div>
                    </div>
                </div>

                <!-- Specifications -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title mb-0">Thông số kỹ thuật</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-cols-2 gap-2">
                            <div class="form-group">
                                <label class="form-label">Dung lượng pin</label>
                                <input type="text" class="form-control" name="battery" value="@Model.Vehicle.Battery" placeholder="Ví dụ: 75kWh" />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Quãng đường</label>
                                <input type="text" class="form-control" name="range" value="@Model.Vehicle.Range" placeholder="Ví dụ: 500km" />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Công suất</label>
                                <input type="text" class="form-control" name="power" value="@Model.Vehicle.Power" placeholder="Ví dụ: 350hp" />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tăng tốc 0-100km/h</label>
                                <input type="text" class="form-control" name="acceleration" value="@Model.Vehicle.Acceleration" placeholder="Ví dụ: 4.5s" />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tốc độ tối đa</label>
                                <input type="text" class="form-control" name="maxSpeed" value="@Model.Vehicle.MaxSpeed" placeholder="Ví dụ: 220km/h" />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Số chỗ ngồi</label>
                                <input type="number" class="form-control" name="seats" value="@Model.Vehicle.Seats" placeholder="5" />
                            </div>
                        </div>

                        <div class="form-group mb-0">
                            <label class="form-label">Thông số khác (JSON)</label>
                            <textarea class="form-control" name="otherSpecs" rows="4" placeholder='{"transmission": "Automatic", "drivetrain": "AWD"}'>@Model.Vehicle.OtherSpecs</textarea>
                            <small class="form-text">Các thông số bổ sung dạng JSON (tùy chọn)</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Preview & Actions -->
            <div>
                <!-- Preview Card -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title mb-0">Preview</h3>
                    </div>
                    <div class="card-body">
                        <div id="preview-image" style="width: 100%; height: 200px; background: var(--black); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; margin-bottom: 1rem; overflow: hidden;">
                            @if (!string.IsNullOrEmpty(Model.Vehicle.ImageUrl))
                            {
                                <img src="@Model.Vehicle.ImageUrl" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<i class=\\'bi bi-image-fill\\' style=\\'font-size: 3rem; color: var(--error);\\></i>'" />
                            }
                            else
                            {
                                <i class="bi bi-image" style="font-size: 3rem; color: var(--text-muted);"></i>
                            }
                        </div>
                        <div id="preview-name" style="font-size: 1.25rem; font-weight: 600; color: var(--text-heading); margin-bottom: 0.5rem;">
                            @Model.Vehicle.ModelName @Model.Vehicle.VariantName
                        </div>
                        <div id="preview-specs" class="text-muted" style="font-size: 0.875rem;">
                            @if (!string.IsNullOrEmpty(Model.Vehicle.Battery) || !string.IsNullOrEmpty(Model.Vehicle.Range) || !string.IsNullOrEmpty(Model.Vehicle.Power))
                            {
                                var specParts = new List<string>();
                                if (!string.IsNullOrEmpty(Model.Vehicle.Battery)) specParts.Add($"Pin: {Model.Vehicle.Battery}");
                                if (!string.IsNullOrEmpty(Model.Vehicle.Range)) specParts.Add($"Quãng đường: {Model.Vehicle.Range}");
                                if (!string.IsNullOrEmpty(Model.Vehicle.Power)) specParts.Add($"Công suất: {Model.Vehicle.Power}");
                                @string.Join(" • ", specParts)
                            }
                            else
                            {
                                <text>Thông số sẽ hiển thị ở đây</text>
                            }
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="card">
                    <div class="card-body">
                        <button type="submit" class="btn btn-primary btn-block mb-2">
                            <i class="bi bi-check-circle"></i> Cập nhật
                        </button>
                        <a href="/EVM/Vehicles/Index" class="btn btn-secondary btn-block">
                            Hủy
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
}

@section Scripts {
    <script>
        // Preview image
        document.querySelector('input[name="imageUrl"]')?.addEventListener('input', function() {
            const url = this.value;
            const preview = document.getElementById('preview-image');
            if (url) {
                preview.innerHTML = '<img src="' + url + '" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML=\'<i class=\\'bi bi-image-fill\\' style=\\'font-size: 3rem; color: var(--error);\\></i>\'" />';
            }
        });

        // Preview name
        const updatePreview = () => {
            const modelName = document.querySelector('input[name="modelName"]').value || 'Model Name';
            const variantName = document.querySelector('input[name="variantName"]').value || 'Variant';
            document.getElementById('preview-name').textContent = modelName + ' ' + variantName;
        };
        
        document.querySelector('input[name="modelName"]')?.addEventListener('input', updatePreview);
        document.querySelector('input[name="variantName"]')?.addEventListener('input', updatePreview);

        // Calculate vehicle price with discount
        function calculateVehiclePrice() {
            var discountInput = document.getElementById('vehicleDiscountPercent');
            var msrpInput = document.getElementById('vehicleMsrp');
            var wholesaleInput = document.getElementById('vehicleWholesalePrice');
            var previewDiv = document.getElementById('vehiclePricePreview');
            var discountedMsrpSpan = document.getElementById('vehicleDiscountedMsrp');
            var discountedWholesaleSpan = document.getElementById('vehicleDiscountedWholesale');

            if (!msrpInput.value || !wholesaleInput.value) {
                previewDiv.style.display = 'none';
                return;
            }

            var discountPercent = discountInput && discountInput.value ? parseFloat(discountInput.value) : 0;
            
            if (discountPercent > 0) {
                var originalMsrp = parseFloat(msrpInput.value);
                var originalWholesale = parseFloat(wholesaleInput.value);
                
                var discountedMsrp = originalMsrp * (1 - discountPercent / 100);
                var discountedWholesale = originalWholesale * (1 - discountPercent / 100);
                
                discountedMsrpSpan.textContent = 'MSRP: ' + originalMsrp.toLocaleString('vi-VN') + ' VND → ' + discountedMsrp.toLocaleString('vi-VN') + ' VND (giảm ' + discountPercent + '%)';
                discountedWholesaleSpan.textContent = 'Giá sỉ: ' + originalWholesale.toLocaleString('vi-VN') + ' VND → ' + discountedWholesale.toLocaleString('vi-VN') + ' VND (giảm ' + discountPercent + '%)';
                previewDiv.style.display = 'block';
            } else {
                previewDiv.style.display = 'none';
            }
        }

        // Preview specs
        const updateSpecs = () => {
            const battery = document.querySelector('input[name="battery"]').value;
            const range = document.querySelector('input[name="range"]').value;
            const power = document.querySelector('input[name="power"]').value;
            
            let specs = [];
            if (battery) specs.push('Pin: ' + battery);
            if (range) specs.push('Quãng đường: ' + range);
            if (power) specs.push('Công suất: ' + power);
            
            document.getElementById('preview-specs').textContent = specs.join(' • ') || 'Thông số sẽ hiển thị ở đây';
        };
        
        ['battery', 'range', 'power'].forEach(name => {
            document.querySelector('input[name="' + name + '"]')?.addEventListener('input', updateSpecs);
        });
    </script>
}

