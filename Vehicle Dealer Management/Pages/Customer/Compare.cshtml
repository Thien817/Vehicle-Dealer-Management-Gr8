@page
@model Vehicle_Dealer_Management.Pages.Customer.CompareModel
@{
    ViewData["Title"] = "So sánh xe";
    ViewData["UserRole"] = "CUSTOMER";
    ViewData["UserName"] = HttpContext.Session.GetString("UserName") ?? "Customer";
}

<div class="content-header">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="content-title">So sánh xe</h1>
            <p class="content-subtitle">So sánh thông số kỹ thuật và giá của các mẫu xe</p>
        </div>
        <button class="btn btn-primary" onclick="document.getElementById('addVehicleModal').style.display='flex'">
            <i class="bi bi-plus-circle"></i> Thêm xe để so sánh
        </button>
    </div>
</div>

@if (!Model.Vehicles.Any())
{
    <div class="card">
        <div class="card-body" style="text-align: center; padding: 3rem;">
            <i class="bi bi-diagram-3" style="font-size: 4rem; color: var(--accent-cyan); opacity: 0.5; margin-bottom: 1rem;"></i>
            <h3 style="margin-bottom: 0.5rem;">Chưa có xe nào được chọn</h3>
            <p class="text-muted mb-3">Chọn tối đa 4 xe để so sánh</p>
            <button class="btn btn-primary" onclick="document.getElementById('addVehicleModal').style.display='flex'">
                <i class="bi bi-plus-circle"></i> Chọn xe
            </button>
        </div>
    </div>
}
else
{
    <!-- Comparison Table -->
    <div class="card">
        <div class="card-body" style="padding: 0;">
            <div class="table-container">
                <table class="table" style="margin-bottom: 0;">
                    <thead>
                        <tr>
                            <th style="width: 200px;">Thông số</th>
                            @foreach (var vehicle in Model.Vehicles)
                            {
                                <th style="text-align: center; min-width: 250px;">
                                    <div style="position: relative;">
                                        <button class="btn btn-sm btn-danger" 
                                                onclick="removeVehicle(@vehicle.Id)"
                                                style="position: absolute; top: -10px; right: -10px; width: 24px; height: 24px; padding: 0; border-radius: 50%; font-size: 0.75rem;">
                                            <i class="bi bi-x"></i>
                                        </button>
                                        <img src="@vehicle.ImageUrl" alt="@vehicle.ModelName" 
                                             style="width: 100%; max-width: 200px; height: 150px; object-fit: cover; border-radius: var(--radius-sm); margin-bottom: 1rem;" />
                                        <h4 style="margin-bottom: 0.25rem;">@vehicle.ModelName</h4>
                                        <p class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.5rem;">@vehicle.VariantName</p>
                                        @await Html.PartialAsync("_StatusBadge", vehicle.Status)
                                    </div>
                                </th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Price Row -->
                        <tr style="background: var(--black);">
                            <td><strong>Giá bán lẻ</strong></td>
                            @foreach (var vehicle in Model.Vehicles)
                            {
                                <td style="text-align: center;">
                                    @if (vehicle.OriginalPrice.HasValue && vehicle.OriginalPrice.Value > vehicle.Price)
                                    {
                                        <div style="margin-bottom: 0.25rem;">
                                            <span style="font-size: 0.875rem; color: var(--text-muted); text-decoration: line-through;">
                                                @vehicle.OriginalPrice.Value.ToString("N0") VND
                                            </span>
                                        </div>
                                        <div>
                                            <strong style="color: var(--accent-cyan); font-size: 1.125rem;">
                                                @vehicle.Price.ToString("N0") VND
                                            </strong>
                                        </div>
                                        <div style="color: var(--success); font-size: 0.75rem; margin-top: 0.25rem;">
                                            <i class="bi bi-tag-fill"></i> Giảm @(((vehicle.OriginalPrice.Value - vehicle.Price) / vehicle.OriginalPrice.Value * 100).ToString("F0"))%
                                        </div>
                                    }
                                    else
                                    {
                                        <strong style="color: var(--accent-cyan); font-size: 1.125rem;">
                                            @vehicle.Price.ToString("N0") VND
                                        </strong>
                                    }
                                    @if (!string.IsNullOrEmpty(vehicle.PriceNote))
                                    {
                                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                                            @vehicle.PriceNote
                                        </div>
                                    }
                                </td>
                            }
                        </tr>
                        <!-- Specs -->
                        @{
                            var allSpecKeys = Model.Vehicles
                                .SelectMany(v => v.Specs.Keys)
                                .Distinct()
                                .OrderBy(k => k)
                                .ToList();
                        }
                        @foreach (var specKey in allSpecKeys)
                        {
                            <tr>
                                <td><strong>@specKey</strong></td>
                                @foreach (var vehicle in Model.Vehicles)
                                {
                                    <td style="text-align: center;">
                                        @(vehicle.Specs.ContainsKey(specKey) ? vehicle.Specs[specKey] : "-")
                                    </td>
                                }
                            </tr>
                        }
                        <!-- Action Row -->
                        <tr style="background: var(--surface);">
                            <td><strong>Thao tác</strong></td>
                            @foreach (var vehicle in Model.Vehicles)
                            {
                                <td style="text-align: center;">
                                    <a href="/Customer/VehicleDetail?id=@vehicle.Id" class="btn btn-primary btn-sm">
                                        <i class="bi bi-eye"></i> Chi tiết
                                    </a>
                                    <a href="/Customer/RequestQuote?vehicleId=@vehicle.Id" class="btn btn-success btn-sm" style="margin-left: 0.5rem;">
                                        <i class="bi bi-file-text"></i> Yêu cầu báo giá
                                    </a>
                                </td>
                            }
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

<!-- Add Vehicle Modal -->
<div id="addVehicleModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
        <div class="card-header">
            <h3 class="card-title mb-0">Chọn xe để so sánh</h3>
        </div>
        <div class="card-body">
            <form method="get" id="compareForm">
                <div class="grid grid-cols-2 gap-2 mb-3">
                    @foreach (var vehicle in Model.AllVehicles)
                    {
                        var isSelected = Model.Vehicles.Any(v => v.Id == vehicle.Id);
                        <label style="cursor: pointer; border: 2px solid @(isSelected ? "var(--accent-cyan)" : "var(--border)"); border-radius: var(--radius-sm); padding: 1rem; display: flex; align-items: center; gap: 1rem; background: @(isSelected ? "var(--accent-cyan-bg)" : "transparent");">
                            <input type="checkbox" 
                                   name="vehicleIds" 
                                   value="@vehicle.Id" 
                                   @(isSelected ? "checked" : "")
                                   style="width: 20px; height: 20px; cursor: pointer;" />
                            <img src="@vehicle.ImageUrl" alt="@vehicle.Name" 
                                 style="width: 60px; height: 40px; object-fit: cover; border-radius: var(--radius-sm);" />
                            <span style="flex: 1;">@vehicle.Name</span>
                        </label>
                    }
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary">So sánh</button>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('addVehicleModal').style.display='none'">Đóng</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function removeVehicle(vehicleId) {
            const currentIds = '@string.Join(",", Model.Vehicles.Select(v => v.Id))';
            const ids = currentIds.split(',').filter(id => id != vehicleId).join(',');
            if (ids) {
                window.location.href = '/Customer/Compare?ids=' + ids;
            } else {
                window.location.href = '/Customer/Compare';
            }
        }

        document.getElementById('compareForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const checkboxes = document.querySelectorAll('input[name="vehicleIds"]:checked');
            const ids = Array.from(checkboxes).map(cb => cb.value).join(',');
            
            if (ids && checkboxes.length <= 4) {
                window.location.href = '/Customer/Compare?ids=' + ids;
            } else if (checkboxes.length > 4) {
                alert('Chỉ có thể so sánh tối đa 4 xe');
            } else {
                alert('Vui lòng chọn ít nhất một xe để so sánh');
            }
        });
    </script>
}

